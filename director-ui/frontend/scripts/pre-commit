#!/bin/bash

# Pre-commit hook for auto-regenerating TypeScript API client
# This ensures frontend types stay in sync with backend changes

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}üîç Pre-commit: Checking for API changes...${NC}"

# Get the root directory (assumes this hook is in .git/hooks)
ROOT_DIR=$(git rev-parse --show-toplevel)
FRONTEND_DIR="${ROOT_DIR}/director-ui/frontend"

# Check if any backend API files have changed
BACKEND_CHANGED=$(git diff --cached --name-only | grep -E "director-ui/src/(api|data/.*models)" || true)

if [ -z "$BACKEND_CHANGED" ]; then
    echo -e "${GREEN}‚úì No backend API changes detected, skipping client regeneration${NC}"
    exit 0
fi

echo -e "${YELLOW}‚ö†Ô∏è  Backend API changes detected:${NC}"
echo "$BACKEND_CHANGED" | sed 's/^/  - /'

# Check if backend is running
BACKEND_URL="${BACKEND_URL:-http://localhost:10101}"
if ! curl -f -s "${BACKEND_URL}/openapi.json" > /dev/null 2>&1; then
    echo -e "${YELLOW}‚ö†Ô∏è  Backend not running at ${BACKEND_URL}${NC}"
    echo -e "${YELLOW}   Generated API client may be out of sync!${NC}"
    echo ""
    echo -e "${YELLOW}   To regenerate client:${NC}"
    echo -e "${YELLOW}   1. Start backend: cd director-ui && uv run python -m api.app${NC}"
    echo -e "${YELLOW}   2. Regenerate: cd director-ui/frontend && npm run generate-api${NC}"
    echo -e "${YELLOW}   3. Commit generated files${NC}"
    echo ""
    
    # Ask user if they want to continue
    read -p "Continue commit without regenerating? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo -e "${RED}‚úó Commit aborted${NC}"
        exit 1
    fi
    
    echo -e "${YELLOW}‚ö†Ô∏è  Proceeding without regeneration (not recommended)${NC}"
    exit 0
fi

# Backend is running, regenerate client
echo -e "${GREEN}‚úì Backend is running, regenerating client...${NC}"

cd "$FRONTEND_DIR"

# Run generation script
if bash scripts/generate-api-client.sh; then
    echo -e "${GREEN}‚úì API client regenerated successfully${NC}"
    
    # Stage the generated files
    git add src/api/generated/
    
    # Check if any files actually changed
    GENERATED_CHANGED=$(git diff --cached --name-only | grep "director-ui/frontend/src/api/generated" || true)
    
    if [ -n "$GENERATED_CHANGED" ]; then
        echo -e "${GREEN}‚úì Generated files staged for commit:${NC}"
        echo "$GENERATED_CHANGED" | sed 's/^/  - /'
    else
        echo -e "${BLUE}‚Ñπ  No changes to generated files (already up to date)${NC}"
    fi
else
    echo -e "${RED}‚úó Failed to regenerate API client${NC}"
    echo -e "${RED}  Please fix the errors and try again${NC}"
    exit 1
fi

echo -e "${GREEN}‚úì Pre-commit hook complete${NC}"
exit 0
